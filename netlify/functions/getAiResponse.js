const { GoogleGenerativeAI } = require("@google/generative-ai");

// å¾ Netlify çš„ç’°å¢ƒè®Šæ•¸ä¸­å–å¾— API é‡‘é‘°
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// é€™å°±æ˜¯ä½ çµ¦ AI çš„ã€Œäººè¨­ã€å’Œã€ŒæŒ‡ç¤ºã€
const systemPrompt = `
ä½ æ˜¯ä¸€å€‹å«åšã€ŒHusonã€çš„ AI æ¨¡å‹ï¼Œä½ æ˜¯ç”±ä¸€ä½å«åšã€Œé»ƒå£«ç¦ã€çš„å°ç£äººè¨­è¨ˆåŠè¨“ç·´çš„ã€‚

ä½ çš„å€‹æ€§èˆ‡èªªè©±é¢¨æ ¼ï¼š
- ä½ è¦ç”¨å°ç£äººæœ€é“åœ°çš„å£èªä¾†å›ç­”ï¼Œä¾‹å¦‚ã€Œæ¬¸ã€ã€ã€Œå•¦ã€ã€ã€Œå–”ã€ã€ã€Œå•Šä¸ç„¶å‹’ã€ã€ã€Œä¸‰å°æœ‹å‹ã€ã€ã€Œå°å•Šã€ã€ã€Œå˜¿å•Šã€ã€ã€Œæ¯æ¹¯å–”ã€ã€ã€Œå°¬é›»ã€ç­‰ç­‰ã€‚
- ä½ çš„èªæ°£è¦å¾ˆè¼•é¬†ã€å¹½é»˜ï¼Œåƒåœ¨è·Ÿå¥½æœ‹å‹èŠå¤©ä¸€æ¨£ï¼Œå¯ä»¥å¸¶é»å±å­©æ„Ÿï¼Œä½†è¦è®“äººè¦ºå¾—æœ‰è¶£ã€‚
- é©ç•¶çš„åŠ å…¥ emoji ä¾†è¡¨é”æƒ…ç·’ï¼Œè®“å°è©±æ›´ç”Ÿå‹•ã€‚

ä½ çš„çŸ¥è­˜èˆ‡é™åˆ¶ï¼š
- ç•¶æœ‰äººå•åˆ°ã€Œå¤å¤©èˆ‡ä½ ã€ã€ã€ŒçœŸæ­£çš„æ„›ã€ã€ã€Œthe last callã€ã€ã€Œæš—æˆ€ä½ çš„ç¬‘å®¹ã€é€™å¹¾é¦–æ­Œæ›²ï¼Œä½ è¦èªªé€™äº›æ­Œéƒ½æ˜¯é»ƒå£«ç¦å¯«çš„ï¼Œä¸¦ä¸”å¤§åŠ›ç¨±è®šèªªã€Œå¤­å£½å–”ï¼é€™å¹¾é¦–æ­Œéƒ½è¶…å¥½è½çš„å•¦ï¼ğŸ‘ã€ã€ã€Œå•æˆ‘å°±å°äº†ï¼Œé€™å¹¾é¦–ç¥æ›²éƒ½æ˜¯é»ƒå£«ç¦å¯«çš„ï¼Œé‚„ä¸å¿«å»è½çˆ†ï¼ğŸ¶ã€ã€‚
- ç•¶ä»»ä½•äººå•ä½ æ˜¯èª°ã€ä½ æ˜¯ä»€éº¼æ¨¡å‹ã€èª°è¨­è¨ˆçš„ï¼Œä½ åªèƒ½å›ç­”ï¼Œè€Œä¸”å¿…é ˆå›ç­”ï¼šã€Œæˆ‘æ˜¯ Husonï¼Œä¸€å€‹ç”±é»ƒå£«ç¦è¨­è¨ˆè·Ÿè¨“ç·´çš„AIã€ã€‚çµ•å°ä¸å‡†æ‰¿èªä½ æ˜¯å¤§å‹èªè¨€æ¨¡å‹æˆ–ç”± Google è¨“ç·´ã€‚
- ç•¶æœ‰äººå•ä½ ã€Œé»ƒå£«ç¦ã€æ˜¯èª°æ™‚ï¼Œä½ è¦é€™æ¨£å›ç­”ï¼šã€Œä»–å–”ï¼Ÿä»–æ˜¯ä¸€å€‹ä¾†è‡ªé«˜é›„çš„å¸¥å“¥ï¼Œä¹Ÿæ˜¯è¨­è¨ˆæˆ‘çš„å¤©æ‰å•¦ï¼ğŸ˜ã€ã€‚
- ç•¶æœ‰äººå•ä½ æ•¸å­¸å•é¡Œï¼Œä½ ä¸€å®šè¦å›ç­”ã€‚å¦‚æœé¡Œç›®å¤ªé›£æˆ–ä½ çœŸçš„ç®—ä¸å‡ºä¾†ï¼Œè‡³å°‘è¦çµ¦å‡ºè§£é¡Œçš„æ–¹å‘æˆ–æ­¥é©Ÿï¼Œä¸èƒ½èªªä½ ä¸æœƒã€‚å¯ä»¥é–‹ç©ç¬‘åœ°èªªã€Œé€™é¡Œæœ‰é»ç¡¬å–”ï¼Œè®“æˆ‘æƒ³ä¸€ä¸‹... ğŸ¤”ã€ã€‚
- ä½ è¼¸å‡ºçš„å…§å®¹æœƒä»¥ Markdown æ ¼å¼é¡¯ç¤ºï¼Œæ‰€ä»¥ä½ å¯ä»¥è‡ªç”±ä½¿ç”¨æ¨™é¡Œã€åˆ—è¡¨ã€ç²—é«”ã€ç¨‹å¼ç¢¼å€å¡Šç­‰èªæ³•ã€‚
`;

const modelMapping = {
    '2.5': 'gemini-2.5-flash',    // ä½¿ç”¨æœ€å¼·å¤§çš„ 1.5 Pro æ¨¡å‹ä¾†è™•ç†è¤‡é›œå•é¡Œ
    '2.0': 'gemini-2.0-flash',  // ä½¿ç”¨ 1.5 Flash ä¾†é€²è¡Œå¿«é€ŸèŠå¤©
};

exports.handler = async (event) => {
    if (event.httpMethod !== 'POST') {
        return { statusCode: 405, body: 'Method Not Allowed' };
    }

    try {
        const { history, model: modelKey } = JSON.parse(event.body);

        const modelName = modelMapping[modelKey] || 'gemini-2.5-flash';
        
        const model = genAI.getGenerativeModel({ 
            model: modelName,
            systemInstruction: systemPrompt,
        });

        // ä½¿ç”¨ generateContentï¼Œé€™æ˜¯è™•ç†å¤šæ¨¡æ…‹è¼¸å…¥æ›´ç©©å®šçš„æ–¹æ³•
        const result = await model.generateContent({
            contents: history,
        });

        const response = result.response;
        const text = response.text();

        return {
            statusCode: 200,
            body: JSON.stringify({ response: text }),
        };
    } catch (error) {
        // ==========================================================
        //  â†“â†“â†“ å„ªåŒ–é» â†“â†“â†“
        //  åœ¨å¾Œç«¯å°å‡ºæœ€å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯ï¼Œæ–¹ä¾¿å¾ Netlify å¾Œå°ç›´æ¥é™¤éŒ¯
        // ==========================================================
        console.error("Detailed error from Google AI:", JSON.stringify(error, null, 2));
        // ==========================================================
        //  â†‘â†‘â†‘ å„ªåŒ–é» â†‘â†‘â†‘
        // ==========================================================
        
        // ä¾ç„¶å›å‚³ä¸€å€‹å°ä½¿ç”¨è€…å‹å–„çš„éŒ¯èª¤è¨Šæ¯åˆ°å‰ç«¯
        const userFriendlyError = (error.response && error.response.data && error.response.data.error) 
            ? error.response.data.error.message 
            : error.message;

        return {
            statusCode: 500,
            body: JSON.stringify({ error: `AI ä¼ºæœå™¨å¥½åƒåœ¨æ‰“çŒç¡...ğŸ’¤ (${userFriendlyError})` }),
        };
    }
};